<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${post.title}">ê²Œì‹œê¸€ ìƒì„¸ | Study With Me</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/board.css" />
    <link rel="stylesheet" href="/css/lightbox.css" />
    
    <!-- highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body class="light">

<!-- ìƒë‹¨ ìŠ¤í¬ë¡¤ ì§„í–‰ë°” -->
<div id="scrollProgress"></div>

<header class="swm-header">
    <div class="nav-inner">
        <div class="logo" onclick="location.href='/'">Study With Me</div>
        <nav class="nav-links">
            <a href="/">ëª¨ì§‘ ê²Œì‹œíŒ</a>
            <a href="/recommend">AI ì¶”ì²œ</a>
        </nav>
        <div class="nav-actions">
            <div th:if="${loginUser != null}" style="display: flex; gap: 8px; align-items: center;">
                <div class="notif-wrapper">
                    <button id="notifIcon" class="btn btn-outline" type="button">
                        ğŸ””
                        <span id="notifBadge" class="notif-badge hidden"></span>
                    </button>
                    <div id="notifDropdown" class="notif-dropdown hidden"></div>
                </div>
                <a href="/bookmarks" class="btn btn-outline">ë¶ë§ˆí¬</a>
                <a href="/mypage" class="btn btn-outline">ë§ˆì´í˜ì´ì§€</a>
                <a href="/logout" class="btn btn-outline">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <div th:if="${loginUser == null}">
                <a href="/auth" class="btn btn-outline">ë¡œê·¸ì¸</a>
            </div>
            <button id="darkModeBtn" class="btn btn-outline">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
        </div>
    </div>
</header>

<main class="page detail-layout">

    <!------------------ ì™¼ìª½ ë³¸ë¬¸ --------------------->
    <section class="detail-main">

        <!-- ì˜¤ë¥˜/ì„±ê³µ ë©”ì‹œì§€ ë°•ìŠ¤ -->
        <div th:if="${param.error != null}" class="alert-box error" id="errorBox">
            <span class="alert-icon">âš ï¸</span>
            <span th:text="${param.error[0]}">ì˜¤ë¥˜ ë©”ì‹œì§€</span>
            <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
        </div>

        <div th:if="${param.success != null}" class="alert-box success" id="successBox">
            <span class="alert-icon">âœ“</span>
            <span th:if="${param.success[0] == 'post_created'}">ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
            <span th:if="${param.success[0] == 'post_updated'}">ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
            <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
        </div>

        <button class="btn-link" onclick="history.back()">â† ëª©ë¡ìœ¼ë¡œ</button>

        <h1 id="detailTitle" class="detail-title" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</h1>

        <div class="detail-meta">
            <span id="detailCategory" th:if="${post.category != null}" th:text="${post.category}">ì¹´í…Œê³ ë¦¬</span>
            <span id="detailCategory" th:if="${post.category == null}">ê¸°íƒ€</span> Â·
            <span id="detailViews">ì¡°íšŒìˆ˜ <strong th:text="${post.viewCount}">0</strong></span> Â·
            <span id="detailDate" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-11</span>
        </div>

        <!-- ìë™ ëª©ì°¨ -->
        <div id="tocContainer" class="toc-container"></div>

        <!-- ë³¸ë¬¸ -->
        <article id="detailContent" class="detail-content" style="line-height: 1.8;" th:utext="${post.content}">ê²Œì‹œê¸€ ë‚´ìš©</article>

        <!-- AI ìš”ì•½ -->
        <button id="aiSummaryBtn" class="btn btn-outline ai-summary-btn">âœ¨ AI ìš”ì•½ ë³´ê¸°</button>
        <div id="aiSummaryBox" class="ai-summary-box hidden"></div>

        <!-- ëŒ“ê¸€ -->
        <section class="comment-section">
            <div class="comment-header">
                <h2>ëŒ“ê¸€ <span id="commentCount">(0)</span></h2>
                <select id="commentSort">
                    <option value="latest">ìµœì‹ ìˆœ</option>
                    <option value="popular">ì¸ê¸°ìˆœ</option>
                </select>
            </div>

            <div class="comment-write" th:if="${loginUser != null}">
                <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button id="commentBtn" class="btn btn-primary">ë“±ë¡</button>
            </div>

            <div id="commentList" class="comment-list"></div>
        </section>

        <!-- íƒœê·¸ -->
        <div th:if="${post.tags != null && !post.tags.isEmpty()}" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <div class="tag-list">
                <span th:each="tag : ${#strings.arraySplit(post.tags, ',')}" 
                      class="tag" th:text="${tag.trim()}">íƒœê·¸</span>
            </div>
        </div>

        <!-- ì‘ì„±ì ì•¡ì…˜ -->
        <div th:if="${loginUser != null && isAuthor}" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
            <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-primary">ìˆ˜ì •</a>
            <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-outline" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
            </form>
        </div>

    </section>

    <!------------------ ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” --------------------->
    <aside class="detail-side">

        <!-- ì‘ì„±ì -->
        <div class="side-card">
            <h3>ì‘ì„±ì</h3>
            <div class="author-box">
                <img class="author-avatar"
                     th:src="${authorProfile != null && authorProfile.profileImage != null} ? ${authorProfile.profileImage} : 'https://i.pravatar.cc/80?img=' + ${post.user.id}"
                     alt="í”„ë¡œí•„">
                <div>
                    <div class="author-name" th:text="${post.user.realName}">ì‘ì„±ì</div>
                    <div class="author-role">ê²Œì‹œê¸€ ì‘ì„±ì</div>
                    <div class="author-meta-row" th:if="${authorStats != null}">
                        <span class="author-level-badge"
                              th:text="'Lv.' + ${authorStats.level}">Lv.1</span>
                        <div class="author-exp-bar">
                            <div class="author-exp-fill"
                                 th:style="'width:' + ${authorStats.expPercent} + '%'"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒœê·¸ -->
        <div class="side-card" th:if="${post.tags != null && !post.tags.isEmpty()}">
            <h3>íƒœê·¸</h3>
            <div class="tag-list">
                <span th:each="tag : ${#strings.arraySplit(post.tags, ',')}" 
                      class="tag" th:text="${tag.trim()}">íƒœê·¸</span>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë°˜ì‘ -->
        <div class="side-card">
            <h3>ì‹¤ì‹œê°„ ë°˜ì‘</h3>

            <div class="reaction-row">
                â¤ï¸ ì¢‹ì•„ìš”:
                <span id="likeCount" class="reaction-number" th:text="${post.likeCount}">0</span>
                <button id="likeBtn" 
                        th:if="${loginUser != null}"
                        th:data-post-id="${post.id}"
                        th:data-liked="${isLiked}"
                        class="btn btn-outline sm"
                        th:classappend="${isLiked} ? 'active' : ''">
                    <span th:text="${isLiked} ? 'ì·¨ì†Œ' : 'ì¢‹ì•„ìš”'">ì¢‹ì•„ìš”</span>
                </button>
            </div>

            <div class="reaction-row">
                ğŸ”– ë¶ë§ˆí¬:
                <span id="bookmarkStatus" th:text="${isBookmarked ? 'ON' : 'OFF'}">OFF</span>
                <button id="bookmarkBtn"
                        th:if="${loginUser != null}"
                        th:data-post-id="${post.id}"
                        th:data-bookmarked="${isBookmarked}"
                        class="btn btn-outline sm">
                    <span th:text="${isBookmarked} ? 'ë¶ë§ˆí¬ í•´ì œ' : 'ë¶ë§ˆí¬'">ë¶ë§ˆí¬</span>
                </button>
            </div>

            <div class="reaction-row" th:if="${loginUser != null && !isAuthor}">
                ğŸ§‘â€ğŸ¤â€ğŸ§‘ ì°¸ì—¬ í¬ë§:
                <span id="applyCount" class="reaction-number" th:text="${applicationCount}">0</span>
                <button id="applyBtn"
                        th:data-post-id="${post.id}"
                        th:data-has-applied="${hasApplied}"
                        th:classappend="${hasApplied} ? 'btn btn-primary sm' : 'btn btn-outline sm'">
                    <span th:text="${hasApplied} ? 'ì§€ì› ì·¨ì†Œ' : 'ì§€ì›í•˜ê¸°'">ì§€ì›í•˜ê¸°</span>
                </button>
            </div>
        </div>

        <!-- ì‘ì„±ìì˜ ë‹¤ë¥¸ ìŠ¤í„°ë”” -->
        <div class="side-card">
            <h3>ì‘ì„±ìì˜ ë‹¤ë¥¸ ìŠ¤í„°ë””</h3>
            <ul id="authorPosts" class="author-post-list" th:if="${authorPosts != null and !authorPosts.isEmpty()}">
                <li th:each="p : ${authorPosts}" class="author-post-item">
                    <a th:href="@{/posts/{id}(id=${p.id})}"
                       style="display:block;cursor:pointer;text-decoration:none;color:inherit;">
                        <div style="font-size:13px;font-weight:600;" th:text="${p.title}">ë‹¤ë¥¸ ìŠ¤í„°ë”” ì œëª©</div>
                        <div style="font-size:11px;color:#6b7280;">
                            <span th:text="${p.category != null ? p.category : 'ê¸°íƒ€'}">ì¹´í…Œê³ ë¦¬</span>
                            <span> Â· ì¡°íšŒìˆ˜ </span>
                            <span th:text="${p.viewCount}">0</span>
                        </div>
                    </a>
                </li>
            </ul>
            <div th:if="${authorPosts == null or authorPosts.isEmpty()}" style="font-size:12px;color:#9ca3af;margin-top:6px;">
                ë‹¤ë¥¸ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <!-- ìµœê·¼ ë³¸ ìŠ¤í„°ë”” -->
        <div class="side-card">
            <h3>ìµœê·¼ ë³¸ ìŠ¤í„°ë””</h3>
            <ul id="recentPosts" class="author-post-list">
                <!-- TODO: Implement client-side recent posts logic -->
            </ul>
        </div>

    </aside>

</main>

<!-- ì§€ì›í•˜ê¸° í”Œë¡œíŒ… ë²„íŠ¼ (ì‘ì„±ìê°€ ì•„ë‹Œ ê²½ìš°ë§Œ) -->
<button id="floatingApplyBtn" 
        th:if="${loginUser != null && !isAuthor}"
        class="floating-apply-btn"
        th:data-post-id="${post.id}"
        th:data-has-applied="${hasApplied}">
    <span th:text="${hasApplied} ? 'ì§€ì› ì·¨ì†Œ' : 'ìŠ¤í„°ë”” ì§€ì›í•˜ê¸°'">ìŠ¤í„°ë”” ì§€ì›í•˜ê¸°</span>
</button>

<!-- ë¼ì´íŠ¸ë°•ìŠ¤ -->
<div id="lightbox" class="lightbox hidden">
    <img id="lightboxImg">
</div>

<script src="/js/lightbox.js"></script>
<script src="/js/board.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
const postId = [[${post.id}]];
const isLikedInitial = [[${isLiked}]];
const isBookmarkedInitial = [[${isBookmarked}]];
const hasAppliedInitial = [[${hasApplied}]];
const isAuthor = [[${isAuthor}]];

// ì „ì—­ì—ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ window.loginUser í”Œë˜ê·¸ ì œê³µ
// (board.jsì—ì„œ ëŒ“ê¸€/ì¢‹ì•„ìš” ë“±ì—ì„œ ì‚¬ìš©)
window.loginUser = [[${loginUser != null}]];

// ì¢‹ì•„ìš” ë²„íŠ¼
document.getElementById('likeBtn')?.addEventListener('click', async function() {
    const btn = this;
    const likeCountSpan = document.getElementById('likeCount');
    
    try {
        const response = await fetch(`/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.isLiked) {
                btn.innerHTML = '<span>ì·¨ì†Œ</span>';
                btn.className = 'btn btn-primary sm';
            } else {
                btn.innerHTML = '<span>ì¢‹ì•„ìš”</span>';
                btn.className = 'btn btn-outline sm';
            }
            if (likeCountSpan) {
                likeCountSpan.textContent = result.likeCount;
            }
        } else {
            alert(result.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ë¶ë§ˆí¬ ë²„íŠ¼
document.getElementById('bookmarkBtn')?.addEventListener('click', async function() {
    const btn = this;
    const bookmarkStatusSpan = document.getElementById('bookmarkStatus');
    
    try {
        const response = await fetch(`/posts/${postId}/bookmark`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.isBookmarked) {
                btn.innerHTML = '<span>ë¶ë§ˆí¬ í•´ì œ</span>';
                btn.className = 'btn btn-primary sm';
                if (bookmarkStatusSpan) bookmarkStatusSpan.textContent = 'ON';
            } else {
                btn.innerHTML = '<span>ë¶ë§ˆí¬</span>';
                btn.className = 'btn btn-outline sm';
                if (bookmarkStatusSpan) bookmarkStatusSpan.textContent = 'OFF';
            }
        } else {
            alert(result.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ì§€ì›í•˜ê¸° ë²„íŠ¼
const applyBtn = document.getElementById('applyBtn');
const floatingApplyBtn = document.getElementById('floatingApplyBtn');
const applyCountSpan = document.getElementById('applyCount');

async function handleApply(isCancel) {
    if (!loginUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/auth?error=login_required';
        return;
    }
    
    if (isAuthor) {
        alert('ë³¸ì¸ì˜ ê²Œì‹œê¸€ì—ëŠ” ì§€ì›í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    let message = null;
    if (!isCancel) {
        const userInput = prompt('ì§€ì› ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­, ì·¨ì†Œí•˜ë©´ ë©”ì‹œì§€ ì—†ì´ ì§€ì›):');
        if (userInput === null) {
            // ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” ë©”ì‹œì§€ ì—†ì´ ì§€ì›
            if (!confirm('ë©”ì‹œì§€ ì—†ì´ ì§€ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
        } else {
            message = userInput;
        }
    }
    
    const url = isCancel ? `/posts/${postId}/cancel-apply` : `/posts/${postId}/apply`;
    const formData = new FormData();
    if (message) formData.append('message', message);
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const hasApplied = !isCancel;
            if (applyBtn) {
                applyBtn.innerHTML = hasApplied ? '<span>ì§€ì› ì·¨ì†Œ</span>' : '<span>ì§€ì›í•˜ê¸°</span>';
                applyBtn.className = hasApplied ? 'btn btn-primary sm' : 'btn btn-outline sm';
                applyBtn.dataset.hasApplied = hasApplied;
            }
            if (floatingApplyBtn) {
                floatingApplyBtn.innerHTML = hasApplied ? '<span>ì§€ì› ì·¨ì†Œ</span>' : '<span>ìŠ¤í„°ë”” ì§€ì›í•˜ê¸°</span>';
                floatingApplyBtn.dataset.hasApplied = hasApplied;
            }
            if (applyCountSpan) {
                applyCountSpan.textContent = result.applicationCount || 0;
            }
            alert(result.message || (hasApplied ? 'ì§€ì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì§€ì›ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'));
        } else {
            alert(result.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

applyBtn?.addEventListener('click', function() {
    const hasApplied = this.dataset.hasApplied === 'true';
    handleApply(hasApplied);
});

floatingApplyBtn?.addEventListener('click', function() {
    const hasApplied = this.dataset.hasApplied === 'true';
    handleApply(hasApplied);
});

// ì½”ë“œ í•˜ì´ë¼ì´íŠ¸
if (window.hljs) {
    document.querySelectorAll('pre code').forEach((block) => {
        window.hljs.highlightElement(block);
    });
}
/*]]>*/
</script>
</body>
</html>
