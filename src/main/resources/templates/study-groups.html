<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>진행중인 스터디 | Study With Me</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/board.css" />
    <link rel="stylesheet" href="/css/study-group.css" />
</head>
<body class="light">

<header class="swm-header">
    <div class="nav-inner">
        <div class="logo" onclick="location.href='/'">Study With Me</div>
        <nav class="nav-links">
            <a href="/">모집 게시판</a>
            <a href="/recommend">AI 추천</a>
            <a href="/study-groups" class="active">진행중인 스터디</a>
        </nav>
        <div class="nav-actions">
            <div th:if="${loginUser != null}" style="display: flex; gap: 8px; align-items: center;">
                <a href="/my-applications" class="btn btn-outline">내 지원현황</a>
                <a href="/bookmarks" class="btn btn-outline">북마크</a>
                <a href="/mypage" class="btn btn-outline">마이페이지</a>
                <a href="/logout" class="btn btn-outline">로그아웃</a>
            </div>
        </div>
    </div>
</header>

<main class="page study-page">
    <div class="study-container">
        <!-- 왼쪽: 스터디 목록 (최대 3개) -->
        <div class="study-list-panel">
            <div class="study-list-header">
                <h2>진행중인 스터디</h2>
                <p>최대 3개까지 참여 가능합니다</p>
            </div>
            <div class="study-list-scroll">
                <div th:if="${groups == null || groups.isEmpty()}" class="empty-state">
                    <div class="empty-state-icon"></div>
                    <div class="empty-state-text">진행중인 스터디가 없습니다</div>
                    <div class="empty-state-desc">스터디를 찾아보고 참여해보세요!</div>
                    <a href="/" class="btn btn-primary" style="margin-top: 16px;">스터디 찾아보기</a>
                </div>
                
                <div th:if="${groups != null && !groups.isEmpty()}">
                    <div th:each="group, iterStat : ${groups}" 
                         th:if="${iterStat.index < 3}"
                         class="study-card" 
                         th:attr="data-group-id=${group.id}"
                         th:classappend="${iterStat.first ? 'active' : ''}"
                         th:onclick="'selectStudy(' + ${group.id} + ')'">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--primary), #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; font-weight: 600;">
                                S
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div class="study-card-title" th:text="${group.title}">스터디 그룹 이름</div>
                                <div class="study-card-meta" style="margin-top: 4px;">
                                    <span th:text="${group.category != null ? group.category : '기타'}">카테고리</span> · 
                                    <span th:text="${group.currentMembers != null ? group.currentMembers : 0}">0</span> / <span th:text="${group.maxMembers != null ? group.maxMembers : 0}">0</span>명
                                </div>
                            </div>
                        </div>
                        <div class="study-card-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 45%;"></div>
                            </div>
                            <span class="progress-text">45%</span>
                        </div>
                        <div class="study-card-members" style="margin-top: 8px;">
                            <span class="online-indicator"></span>
                            <span id="onlineCount" th:attr="data-group-id=${group.id}">0명 온라인</span>
                        </div>
                    </div>
                    
                    <div th:if="${groups.size() >= 3}" style="padding: 12px; text-align: center; font-size: 12px; color: #ef4444;">
                        최대 3개까지만 참여 가능합니다
                    </div>
                </div>
            </div>
        </div>

        <!-- 오른쪽: 스터디 상세 정보 -->
        <div class="study-detail-panel" th:if="${groups != null && !groups.isEmpty()}">
            <div th:each="group, iterStat : ${groups}" th:if="${iterStat.first}" th:with="firstGroup=${group}">
                <div class="study-detail-header">
                    <div class="study-detail-title" id="detailTitle" th:text="${firstGroup.title}">스터디 그룹 이름</div>
                    <div class="study-detail-meta">
                        <span id="detailCategory" th:text="${firstGroup.category != null ? firstGroup.category : '기타'}">카테고리</span> · 
                        <span id="detailMembers" th:text="${#strings.concat(firstGroup.currentMembers != null ? firstGroup.currentMembers : 0, ' / ', firstGroup.maxMembers != null ? firstGroup.maxMembers : 0, '명')}">0 / 0명</span>
                    </div>
                </div>
            
                <div class="study-detail-content">
                <!-- 메인 콘텐츠 -->
                <div class="study-main-content">
                    <!-- 커리큘럼 -->
                    <div class="study-section">
                        <div class="section-title">
                            <span class="section-icon"></span>
                            커리큘럼
                        </div>
                        <div class="study-section-scrollable">
                        <ul class="curriculum-list">
                            <li class="curriculum-item completed">
                                <div class="curriculum-item-title">1주차: 기초 문법</div>
                                <div class="curriculum-item-desc">변수, 데이터 타입, 연산자</div>
                            </li>
                            <li class="curriculum-item completed">
                                <div class="curriculum-item-title">2주차: 제어문</div>
                                <div class="curriculum-item-desc">조건문, 반복문</div>
                            </li>
                            <li class="curriculum-item current">
                                <div class="curriculum-item-title">3주차: 함수와 객체</div>
                                <div class="curriculum-item-desc">함수 정의, 객체 생성</div>
                            </li>
                            <li class="curriculum-item">
                                <div class="curriculum-item-title">4주차: 배열과 문자열</div>
                                <div class="curriculum-item-desc">배열 메서드, 문자열 처리</div>
                            </li>
                            <li class="curriculum-item">
                                <div class="curriculum-item-title">5주차: 프로젝트 실습</div>
                                <div class="curriculum-item-desc">미니 프로젝트 진행</div>
                            </li>
                        </ul>
                        </div>
                    </div>

                    <!-- 진행중인 진도 -->
                    <div class="study-section">
                        <div class="section-title">
                            <span class="section-icon"></span>
                            진행 진도
                        </div>
                        <div class="progress-section">
                            <div class="progress-large">
                                <div class="progress-large-fill" style="width: 45%;"></div>
                            </div>
                            <div class="progress-percentage">45%</div>
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                            3주차 진행 중 · 완료까지 약 2주 남음
                        </div>
                    </div>

                    <!-- 교재 -->
                    <div class="study-section">
                        <div class="section-title">
                            <span class="section-icon"></span>
                            교재
                        </div>
                        <div class="resource-list">
                            <div class="resource-item">
                                <div class="resource-icon" style="font-size: 18px; font-weight: 600;">B</div>
                                <div class="resource-info">
                                    <div class="resource-name">자바스크립트 완벽 가이드</div>
                                    <a href="#" class="resource-link">교재 링크 보기 →</a>
                                </div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon" style="font-size: 18px; font-weight: 600;">B</div>
                                <div class="resource-info">
                                    <div class="resource-name">모던 자바스크립트 Deep Dive</div>
                                    <a href="#" class="resource-link">교재 링크 보기 →</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 인강 -->
                    <div class="study-section">
                        <div class="section-title">
                            <span class="section-icon"></span>
                            인강
                        </div>
                        <div class="resource-list">
                            <div class="resource-item">
                                <div class="resource-icon" style="font-size: 18px; font-weight: 600;">V</div>
                                <div class="resource-info">
                                    <div class="resource-name">자바스크립트 기초 강의</div>
                                    <a href="#" class="resource-link">강의 링크 보기 →</a>
                                </div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon" style="font-size: 18px; font-weight: 600;">V</div>
                                <div class="resource-info">
                                    <div class="resource-name">실전 프로젝트 강의</div>
                                    <a href="#" class="resource-link">강의 링크 보기 →</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 댓글창 -->
                    <div class="study-section">
                        <div class="section-title">
                            <span class="section-icon"></span>
                            댓글
                        </div>
                        <div class="comment-section">
                            <div class="comment-list">
                                <div class="comment-item">
                                    <img class="comment-avatar" th:src="'https://i.pravatar.cc/40?img=1'" alt="프로필">
                                    <div class="comment-body">
                                        <div class="comment-top">
                                            <span class="comment-user">김철수</span>
                                            <span class="comment-time">2시간 전</span>
                                        </div>
                                        <div class="comment-content">오늘 진도 어디까지 나가나요?</div>
                                    </div>
                                </div>
                                <div class="comment-item">
                                    <img class="comment-avatar" th:src="'https://i.pravatar.cc/40?img=2'" alt="프로필">
                                    <div class="comment-body">
                                        <div class="comment-top">
                                            <span class="comment-user">이영희</span>
                                            <span class="comment-time">1시간 전</span>
                                        </div>
                                        <div class="comment-content">3주차 함수 부분까지 예정입니다!</div>
                                    </div>
                                </div>
                            </div>
                            <div class="comment-write" th:if="${loginUser != null}">
                                <textarea id="commentInput" placeholder="댓글을 입력하세요..."></textarea>
                                <button class="btn btn-primary" onclick="addComment()">등록</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 사이드바 -->
                <div class="study-sidebar">
                    <!-- 학습 시작 버튼 -->
                    <div class="sidebar-section">
                        <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600;" 
                                th:onclick="'location.href=\'/study-groups/' + ${firstGroup.id} + '/session\''">
                            학습 시작하기
                        </button>
                    </div>

                    <!-- 온라인 멤버 -->
                    <div class="sidebar-section">
                        <div class="sidebar-title">팀원 정보</div>
                        <div id="membersList" class="online-members">
                            <!-- 팀원 정보가 여기에 동적으로 추가됨 -->
                        </div>
                    </div>

                    <!-- 공부 시간 통계 -->
                    <div class="sidebar-section">
                        <div class="sidebar-title">팀 공부 시간</div>
                        <div class="study-time">
                            <div class="study-time-item">
                                <span class="study-time-label">오늘</span>
                                <span class="study-time-value" id="teamTodayTime">0h 0m</span>
                            </div>
                            <div class="study-time-item">
                                <span class="study-time-label">이번 주</span>
                                <span class="study-time-value" id="teamWeekTime">0h 0m</span>
                            </div>
                            <div class="study-time-item">
                                <span class="study-time-label">전체</span>
                                <span class="study-time-value" id="teamTotalTime">0h 0m</span>
                            </div>
                        </div>
                    </div>

                    <!-- 공용 달력 -->
                    <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div class="sidebar-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>공용 달력</span>
                            <button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px;" onclick="openAddEventModal()">일정 추가</button>
                        </div>
                        <div id="calendarContainer" style="flex: 1; overflow-y: auto; padding: 8px;">
                            <!-- 달력이 여기에 동적으로 생성됨 -->
                        </div>
                    </div>

                    <!-- 채팅창 -->
                    <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0; padding: 0;">
                        <div style="padding: 16px; border-bottom: 1px solid var(--border);">
                            <div class="sidebar-title">그룹 채팅</div>
                        </div>
                        <div class="chat-section">
                            <div class="chat-messages" id="chatMessages">
                                <div class="chat-message">
                                    <img class="chat-avatar" th:src="'https://i.pravatar.cc/32?img=1'" alt="프로필">
                                    <div>
                                        <div class="chat-name">김철수</div>
                                        <div class="chat-bubble">
                                            <div class="chat-text">안녕하세요! 오늘도 화이팅입니다</div>
                                            <div class="chat-time">오전 9:00</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="chat-message own">
                                    <img class="chat-avatar" th:src="'https://i.pravatar.cc/32?img=10'" alt="프로필">
                                    <div>
                                        <div class="chat-name">나</div>
                                        <div class="chat-bubble">
                                            <div class="chat-text">네! 같이 열심히 해요</div>
                                            <div class="chat-time">오전 9:05</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input">
                                <input type="text" id="chatInput" placeholder="메시지를 입력하세요..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                                <button onclick="sendChatMessage()">전송</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- 빈 상태 (스터디가 없을 때) -->
        <div class="study-detail-panel" th:if="${groups == null || groups.isEmpty()}">
            <div class="empty-state">
                <div class="empty-state-icon"></div>
                <div class="empty-state-text">스터디를 선택해주세요</div>
                <div class="empty-state-desc">왼쪽에서 진행중인 스터디를 선택하면<br>상세 정보를 확인할 수 있습니다</div>
            </div>
        </div>
    </div>
</main>

<!-- 일정 모달 -->
<div id="eventModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>일정 관리</h3>
            <button onclick="closeEventModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div id="modalDate" style="font-weight: 600; margin-bottom: 16px;"></div>
        
        <div id="modalEvents" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
            <!-- 일정 목록이 여기에 표시됨 -->
        </div>
        
        <div style="border-top: 1px solid var(--border); padding-top: 16px;">
            <h4 style="margin-bottom: 12px;">새 일정 추가</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">날짜</label>
                    <input type="date" id="newEventDate" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">시간 (선택사항)</label>
                    <input type="time" id="newEventTime" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">제목 *</label>
                    <input type="text" id="newEventTitle" placeholder="일정 제목" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">내용 (선택사항)</label>
                    <textarea id="newEventContent" placeholder="일정 내용" style="width: 100%; min-height: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--border); resize: vertical;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveEvent()" style="width: 100%;">일정 저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 일정 상세 모달 -->
<div id="eventDetailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>일정 상세</h3>
            <button onclick="closeEventDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">제목</div>
                <div id="detailEventTitle" style="font-weight: 600; font-size: 18px;"></div>
            </div>
            <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">날짜</div>
                <div id="detailEventDate"></div>
            </div>
            <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">시간</div>
                <div id="detailEventTime"></div>
            </div>
            <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">내용</div>
                <div id="detailEventContent" style="white-space: pre-wrap;"></div>
            </div>
            <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">작성자</div>
                <div id="detailEventAuthor"></div>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 24px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.calendar-day:hover {
    background: var(--primary-soft) !important;
}

.event-item:hover {
    transform: translateX(4px);
    transition: transform 0.2s;
}
</style>

<script>
let currentGroupId = null;

// 스터디 선택 함수
function selectStudy(groupId) {
    currentGroupId = groupId;
    
    // 모든 카드에서 active 클래스 제거
    document.querySelectorAll('.study-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // 선택한 카드에 active 클래스 추가
    const selectedCard = document.querySelector(`[data-group-id="${groupId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // 스터디 상세 정보 로드
    loadStudyDetails(groupId);
}

// 스터디 상세 정보 로드
function loadStudyDetails(groupId) {
    if (!groupId) {
        console.error('그룹 ID가 없습니다.');
        return;
    }
    
    // 팀원 정보 로드
    fetch(`/api/study-groups/${groupId}/members`)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                if (data.members && data.members.length > 0) {
                    renderMembers(data.members);
                    updateOnlineCount(groupId, data.members);
                    updateTeamStats(data.members);
                } else {
                    console.warn('멤버 데이터가 없습니다.');
                    const container = document.getElementById('membersList');
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">멤버 정보를 불러올 수 없습니다.</div>';
                    }
                }
            } else {
                console.error('멤버 정보 로드 실패:', data.error);
            }
        })
        .catch(error => {
            console.error('멤버 정보 로드 중 오류:', error);
        });
    
    // 달력 초기화
    initCalendar();
}

// HTML 이스케이프 함수
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 팀원 정보 렌더링
function renderMembers(members) {
    const container = document.getElementById('membersList');
    if (!container) {
        console.error('멤버 리스트 컨테이너를 찾을 수 없습니다.');
        return;
    }
    
    container.innerHTML = '';
    
    if (!members || members.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">멤버 정보를 불러올 수 없습니다.</div>';
        return;
    }
    
    members.forEach(member => {
        const statusColor = member.isOnline ? '#10b981' : '#9ca3af';
        const statusText = getStatusText(member.status);
        const lastActive = formatLastActive(member.lastActiveTime);
        const studyStyle = member.studyStyle || '미정';
        
        const div = document.createElement('div');
        div.className = 'online-member';
        div.style.marginBottom = '12px';
        div.innerHTML = `
            <div style="position: relative;">
                <img class="online-member-avatar" src="https://i.pravatar.cc/36?img=${member.id}" alt="프로필">
                <span class="online-badge" style="background: ${statusColor};"></span>
            </div>
            <div style="flex: 1;">
                <div class="online-member-name">
                    ${escapeHtml(member.name)} ${member.role === 'CREATOR' ? '<span style="font-size: 11px; color: #f59e0b;">(팀장)</span>' : ''}
                </div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                    ${statusText} · ${lastActive}
                </div>
                ${member.statusMessage ? `<div style="font-size: 11px; color: var(--primary); margin-top: 2px; font-style: italic;">"${escapeHtml(member.statusMessage)}"</div>` : ''}
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                    오늘: ${formatTime(member.todayStudyTime)} · 스타일: ${studyStyle}
                </div>
                <div style="font-size: 11px; color: #ef4444; margin-top: 2px; font-weight: 600;">
                    연속 ${member.consecutiveDays || 0}일
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

// 온라인 멤버 수 업데이트
function updateOnlineCount(groupId, members) {
    const onlineCount = members.filter(m => m.isOnline).length;
    const countElement = document.querySelector(`[data-group-id="${groupId}"] #onlineCount`);
    if (countElement) {
        countElement.textContent = `${onlineCount}명 온라인`;
    }
}

// 팀 통계 업데이트
function updateTeamStats(members) {
    const todayTotal = members.reduce((sum, m) => sum + (m.todayStudyTime || 0), 0);
    const weekTotal = members.reduce((sum, m) => sum + (m.weekStudyTime || 0), 0);
    const totalTotal = members.reduce((sum, m) => sum + (m.totalStudyTime || 0), 0);
    
    const todayEl = document.getElementById('teamTodayTime');
    const weekEl = document.getElementById('teamWeekTime');
    const totalEl = document.getElementById('teamTotalTime');
    
    if (todayEl) todayEl.textContent = formatTime(todayTotal);
    if (weekEl) weekEl.textContent = formatTime(weekTotal);
    if (totalEl) totalEl.textContent = formatTime(totalTotal);
}

// 유틸리티 함수
function formatTime(minutes) {
    if (typeof minutes === 'number') {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return h > 0 ? `${h}h ${m}m` : `${m}m`;
    }
    return minutes || '0m';
}

function formatLastActive(time) {
    if (!time) return '오프라인';
    const now = new Date();
    const active = new Date(time);
    const diff = Math.floor((now - active) / 1000 / 60);
    
    if (diff < 1) return '방금 전';
    if (diff < 60) return `${diff}분 전`;
    const hours = Math.floor(diff / 60);
    if (hours < 24) return `${hours}시간 전`;
    return '오프라인';
}

function getStatusText(status) {
    const statusMap = {
        'ONLINE': '온라인',
        'AWAY': '자리비움',
        'STUDYING': '학습 중',
        'BREAK': '쉬는 시간',
        'OFFLINE': '오프라인'
    };
    return statusMap[status] || '오프라인';
}

// 댓글 추가
function addComment() {
    const input = document.getElementById('commentInput');
    const text = input.value.trim();
    if (!text) return;
    
    // TODO: 서버에 댓글 전송
    console.log('Adding comment:', text);
    input.value = '';
}

// 채팅 메시지 전송
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    
    // TODO: 서버에 채팅 메시지 전송
    console.log('Sending message:', text);
    input.value = '';
}

// 달력 초기화
let currentCalendarYear = new Date().getFullYear();
let currentCalendarMonth = new Date().getMonth() + 1;

function initCalendar() {
    if (!currentGroupId) return;
    renderCalendar(currentCalendarYear, currentCalendarMonth);
    loadCalendarEvents(currentCalendarYear, currentCalendarMonth);
}

function renderCalendar(year, month) {
    const container = document.getElementById('calendarContainer');
    if (!container) return;
    
    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();
    const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
    const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
    
    let html = `
        <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <button onclick="changeMonth(-1)" style="background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text);">&lt;</button>
                <div style="font-weight: 600; font-size: 16px;">${year}년 ${monthNames[month - 1]}</div>
                <button onclick="changeMonth(1)" style="background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text);">&gt;</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 8px;">
    `;
    
    // 요일 헤더
    dayNames.forEach(day => {
        html += `<div style="text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; padding: 4px;">${day}</div>`;
    });
    
    // 빈 칸 (첫 날 전)
    for (let i = 0; i < firstDay; i++) {
        html += `<div style="aspect-ratio: 1; border: 1px solid var(--border); border-radius: 4px;"></div>`;
    }
    
    // 날짜 칸
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = new Date().toISOString().split('T')[0] === dateStr;
        html += `
            <div class="calendar-day" 
                 data-date="${dateStr}"
                 onclick="showDayEvents('${dateStr}')"
                 style="aspect-ratio: 1; border: 1px solid var(--border); border-radius: 4px; padding: 4px; cursor: pointer; position: relative; ${isToday ? 'background: var(--primary-soft); border-color: var(--primary);' : ''}">
                <div style="font-size: 12px; font-weight: ${isToday ? '700' : '400'}; color: ${isToday ? 'var(--primary)' : 'var(--text)'};">${day}</div>
                <div class="calendar-events" data-date="${dateStr}" style="margin-top: 2px;"></div>
            </div>
        `;
    }
    
    html += `</div></div>`;
    container.innerHTML = html;
}

function changeMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
    } else if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
    }
    renderCalendar(currentCalendarYear, currentCalendarMonth);
    loadCalendarEvents(currentCalendarYear, currentCalendarMonth);
}

function loadCalendarEvents(year, month) {
    if (!currentGroupId) return;
    
    fetch(`/api/study-groups/${currentGroupId}/calendar/events/month/${year}/${month}`)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (data.success && data.events) {
                // 기존 이벤트 점 제거
                document.querySelectorAll('.calendar-events').forEach(el => {
                    el.innerHTML = '';
                });
                
                // 새 이벤트 점 추가
                data.events.forEach(event => {
                    const dateStr = event.eventDate;
                    const dayCell = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
                    if (dayCell) {
                        const eventsDiv = dayCell.querySelector('.calendar-events');
                        if (eventsDiv) {
                            const eventDot = document.createElement('div');
                            eventDot.style.cssText = `width: 6px; height: 6px; border-radius: 50%; background: ${event.color || '#3b82f6'}; margin: 1px auto;`;
                            eventDot.title = event.title;
                            eventsDiv.appendChild(eventDot);
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('달력 이벤트 로드 중 오류:', error);
        });
}

function showDayEvents(dateStr) {
    if (!currentGroupId) return;
    
    fetch(`/api/study-groups/${currentGroupId}/calendar/events/date/${dateStr}`)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                openEventModal(dateStr, data.events);
            } else {
                console.error('일정 조회 실패:', data.error);
            }
        })
        .catch(error => {
            console.error('일정 조회 중 오류:', error);
        });
}

function openEventModal(dateStr, events) {
    const modal = document.getElementById('eventModal');
    const modalDate = document.getElementById('modalDate');
    const modalEvents = document.getElementById('modalEvents');
    
    if (!modal || !modalDate || !modalEvents) return;
    
    const date = new Date(dateStr + 'T00:00:00');
    modalDate.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
    
    modalEvents.innerHTML = '';
    
    if (events && events.length > 0) {
        events.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-item';
            eventDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border-left: 4px solid ' + (event.color || '#3b82f6') + '; background: var(--bg); border-radius: 4px; cursor: pointer;';
            eventDiv.onclick = () => showEventDetail(event);
            eventDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(event.title)}</div>
                ${event.eventTime ? `<div style="font-size: 12px; color: #6b7280; margin-bottom: 2px;">시간: ${event.eventTime}</div>` : ''}
                <div style="font-size: 12px; color: #6b7280;">작성자: ${escapeHtml(event.userName)}</div>
            `;
            modalEvents.appendChild(eventDiv);
        });
    } else {
        modalEvents.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">일정이 없습니다.</div>';
    }
    
    document.getElementById('newEventDate').value = dateStr;
    modal.style.display = 'flex';
}

function openAddEventModal() {
    const modal = document.getElementById('eventModal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('modalEvents').innerHTML = '';
        document.getElementById('newEventDate').value = '';
        document.getElementById('newEventTitle').value = '';
        document.getElementById('newEventTime').value = '';
        document.getElementById('newEventContent').value = '';
    }
}

function closeEventModal() {
    const modal = document.getElementById('eventModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function showEventDetail(event) {
    const detailModal = document.getElementById('eventDetailModal');
    if (!detailModal) return;
    
    document.getElementById('detailEventTitle').textContent = event.title;
    document.getElementById('detailEventDate').textContent = event.eventDate;
    document.getElementById('detailEventTime').textContent = event.eventTime || '시간 미정';
    document.getElementById('detailEventContent').textContent = event.content || '내용 없음';
    document.getElementById('detailEventAuthor').textContent = event.userName;
    
    detailModal.style.display = 'flex';
}

function closeEventDetailModal() {
    const modal = document.getElementById('eventDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function saveEvent() {
    if (!currentGroupId) {
        alert('스터디 그룹을 선택해주세요.');
        return;
    }
    
    const date = document.getElementById('newEventDate').value;
    const time = document.getElementById('newEventTime').value;
    const title = document.getElementById('newEventTitle').value.trim();
    const content = document.getElementById('newEventContent').value.trim();
    
    if (!date || !title) {
        alert('날짜와 제목을 입력해주세요.');
        return;
    }
    
    const params = new URLSearchParams();
    params.append('eventDate', date);
    if (time) params.append('eventTime', time);
    params.append('title', title);
    if (content) params.append('content', content);
    params.append('eventType', 'STUDY');
    params.append('color', '#3b82f6');
    
    fetch(`/api/study-groups/${currentGroupId}/calendar/events?${params.toString()}`, {
        method: 'POST'
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            closeEventModal();
            loadCalendarEvents(currentCalendarYear, currentCalendarMonth);
            alert('일정이 저장되었습니다.');
            if (data.event && data.event.eventDate === date) {
                showDayEvents(date);
            }
        } else {
            alert('일정 저장에 실패했습니다: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('일정 저장 중 오류:', error);
        alert('일정 저장 중 오류가 발생했습니다.');
    });
}

// 페이지 로드 시 첫 번째 스터디 선택 및 주기적 업데이트
document.addEventListener('DOMContentLoaded', function() {
    const firstCard = document.querySelector('.study-card');
    if (firstCard) {
        const groupId = firstCard.getAttribute('data-group-id');
        selectStudy(groupId);
    }
    
    // 5초마다 팀원 정보 업데이트
    setInterval(() => {
        if (currentGroupId) {
            loadStudyDetails(currentGroupId);
        }
    }, 5000);
});
</script>

</body>
</html>

