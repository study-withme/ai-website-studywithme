<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ê²Œì‹œê¸€ ì‘ì„± | Study With Me</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/board.css" />
</head>
<body class="light">

<header class="swm-header">
    <div class="nav-inner">
        <div class="logo" onclick="location.href='/'">Study With Me</div>
        <nav class="nav-links">
            <a href="/">ëª¨ì§‘ ê²Œì‹œíŒ</a>
            <a href="/recommend">AI ì¶”ì²œ</a>
        </nav>
        <div class="nav-actions">
            <div th:if="${loginUser != null}" style="display: flex; gap: 8px; align-items: center;">
                <a href="/mypage" class="btn btn-outline">ë§ˆì´í˜ì´ì§€</a>
                <a href="/logout" class="btn btn-outline">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <button id="darkModeBtn" class="btn btn-outline">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
        </div>
    </div>
</header>

<main class="page create-layout">

    <!---------------- ì‘ì„± í¼ ---------------->
    <section class="post-form">

        <h2 class="create-title">ê²Œì‹œê¸€ ì‘ì„±</h2>
        <p class="create-sub">ê²Œì‹œê¸€ ë‚´ìš©ì„ ìì„¸í•˜ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>

        <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ ë°•ìŠ¤ -->
        <div th:if="${param.error != null}" class="alert-box error" id="errorBox">
            <span class="alert-icon">âš ï¸</span>
            <span th:if="${param.error[0] == 'create_failed'}">
                ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. 
                <span th:if="${param.msg != null}" th:text="'(' + ${param.msg[0]} + ')'"></span>
                ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
            </span>
            <span th:if="${param.error[0] == 'title_required'}">ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            <span th:if="${param.error[0] == 'content_required'}">ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            <span th:if="${param.error[0] == 'login_required'}">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
            <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
        </div>

        <!-- ì„±ê³µ ë©”ì‹œì§€ ë°•ìŠ¤ -->
        <div th:if="${param.success != null}" class="alert-box success" id="successBox">
            <span class="alert-icon">âœ“</span>
            <span th:if="${param.success[0] == 'post_created'}">ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
            <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
        </div>

        <form method="post" action="/posts/write">
            <!-- ì œëª© -->
            <div class="form-section">
                <label class="form-label">ì œëª© *</label>
                <input id="postTitle" name="title" placeholder="ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="200" />
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ -->
            <div class="form-section">
                <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select id="categorySelect" name="category" style="width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--card-bg); font-size: 13px; color: var(--text);">
                    <option value="">ì„ íƒ ì•ˆí•¨</option>
                    <option value="ê°œë°œ">ê°œë°œ</option>
                    <option value="ìê²©ì¦">ìê²©ì¦</option>
                    <option value="ì˜ì–´">ì˜ì–´</option>
                    <option value="ë…ì„œ">ë…ì„œ</option>
                    <option value="ì·¨ì—…">ì·¨ì—…</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>

            <!-- ì§„í–‰ ë°©ì‹/ì§€ì—­/ì •ì› -->
            <div class="form-section">
                <label class="form-label">ì§„í–‰ ë°©ì‹</label>
                <select id="modeSelect" style="width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--card-bg); font-size: 13px; color: var(--text);">
                    <option value="ì˜¨ë¼ì¸">ì˜¨ë¼ì¸</option>
                    <option value="ì˜¤í”„ë¼ì¸">ì˜¤í”„ë¼ì¸</option>
                    <option value="í˜¼í•©">í˜¼í•©</option>
                </select>
            </div>

            <div class="form-section">
                <label class="form-label">ì§€ì—­ (ì˜¤í”„ë¼ì¸ì¼ ê²½ìš°)</label>
                <input id="locationInput" placeholder="ì˜ˆ: ê°•ë‚¨, ì‹ ì´Œ, ë¬´ê´€" style="width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--card-bg); font-size: 13px; color: var(--text);" />
            </div>

            <div class="form-section">
                <label class="form-label">ëª¨ì§‘ ì •ì›</label>
                <input id="capacityInput" type="number" value="0" style="width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--card-bg); font-size: 13px; color: var(--text);" />
            </div>

            <!-- ë³¸ë¬¸ (WYSIWYG) -->
            <div class="form-section">
                <label class="form-label">ë³¸ë¬¸ *</label>

                <div class="editor-toolbar">
                    <button type="button" data-cmd="bold">êµµê²Œ</button>
                    <button type="button" data-cmd="italic">ê¸°ìš¸ì„</button>
                    <button type="button" data-cmd="ul">â€¢ ë¦¬ìŠ¤íŠ¸</button>
                    <button type="button" data-cmd="ol">1. ë¦¬ìŠ¤íŠ¸</button>
                    <button type="button" data-cmd="quote">ì¸ìš©ë¬¸</button>
                    <button type="button" data-cmd="code">ì½”ë“œë¸”ëŸ­</button>
                </div>

                <div id="editor" class="editor-area" contenteditable="true"><h2>ë¡œë“œë§µ ì œì•ˆ</h2>
<p>ìŠ¤í„°ë”” ì§„í–‰ ë¡œë“œë§µì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>

<h2>ìŠ¤í„°ë”” ì†Œê°œ</h2>
<p>ì•ˆë…•í•˜ì„¸ìš”!<br><br>
ìŠ¤í„°ë””ì— ëŒ€í•œ ì†Œê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>

<h3>ì§„í–‰ ë°©ì‹</h3>
<ul>
  <li>ì§„í–‰ ë°©ì‹ì— ëŒ€í•œ ì„¤ëª…ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</li>
</ul>

<h3>ì»¤ë¦¬í˜ëŸ¼ ì˜ˆì‹œ</h3>
<pre><code class="language-java">
// ì½”ë“œ ì˜ˆì‹œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”
</code></pre>

<h2>ì´ëŸ° ë¶„ì´ë©´ ì¢‹ì•„ìš”</h2>
<ul>
  <li>ì°¸ì—¬ ì¡°ê±´ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</li>
</ul>

                <p>ì—´ì •ì ì´ê³  í•¨ê»˜ ì„±ì¥í•˜ì‹¤ ë¶„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ˜Š</p></div>
                <!-- hidden textarea ëŠ” required ë¥¼ ë¹¼ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ submit ìì²´ë¥¼ ë§‰ì•„ì„œ ê¸€ì´ ë“±ë¡ë˜ì§€ ì•ŠìŒ -->
                <textarea id="content" name="content" style="display: none;"></textarea>
                <div class="textarea-meta">ê¸€ì ìˆ˜: <span id="editorLength">0</span></div>
            </div>

            <!-- íƒœê·¸ -->
            <div class="form-section">
                <label class="form-label">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥)</label>
                <input id="tagsInput" name="tags" placeholder="ì˜ˆ: ìŠ¤í„°ë””, Java, Spring Boot" />
                <div class="input-meta">ì‰¼í‘œë¡œ íƒœê·¸ë¥¼ êµ¬ë¶„í•˜ì„¸ìš”</div>
                <button type="button" id="aiTagBtn" class="btn btn-outline sm" style="margin-top:6px;">
                    âœ¨ AI íƒœê·¸ ì¶”ì²œ
                </button>
            </div>

            <!-- ëŒ€í‘œ ì´ë¯¸ì§€ (ìŠ¬ë¼ì´ë“œì‡¼) -->
            <div class="form-section">
                <label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€ URL (ìµœëŒ€ 3ê°œ)</label>
                <input id="imageUrl1" placeholder="ì´ë¯¸ì§€ URL 1" />
                <input id="imageUrl2" placeholder="ì´ë¯¸ì§€ URL 2 (ì„ íƒ)" style="margin-top:6px;" />
                <input id="imageUrl3" placeholder="ì´ë¯¸ì§€ URL 3 (ì„ íƒ)" style="margin-top:6px;" />
                <div class="input-meta">ì´ë¯¸ì§€ëŠ” ìƒì„¸ í˜ì´ì§€ ìƒë‹¨ ìŠ¬ë¼ì´ë“œì‡¼ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>

            <!-- ì œì¶œ -->
            <div class="form-footer">
                <span class="form-caption">ë“±ë¡ í›„ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
                <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
            </div>
        </form>

    </section>

    <!---------------- ìš°ì¸¡ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ---------------->
    <section class="post-side">
        <div class="side-card preview-card">
            <div class="preview-category" id="previewCategory">ì¹´í…Œê³ ë¦¬</div>
            <div class="preview-title" id="previewTitle">ì œëª© ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="preview-meta">
                <span id="previewMode">ì˜¨ë¼ì¸</span> Â·
                <span id="previewLocation">ì§€ì—­</span> Â·
                <span id="previewCapacity">0 / 0ëª…</span>
            </div>
            <div id="previewTags" class="preview-tags"></div>
        </div>
    </section>

</main>

<script src="/js/board.js"></script>
<script>
function showError(message) {
    const errorBox = document.getElementById('errorBox');
    if (errorBox) {
        errorBox.remove();
    }
    const form = document.querySelector('.post-form');
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert-box error';
    alertDiv.id = 'errorBox';
    alertDiv.innerHTML = `
        <span class="alert-icon">âš ï¸</span>
        <span>${message}</span>
        <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
    `;
    form.insertBefore(alertDiv, form.firstChild.nextSibling);
    setTimeout(() => {
        alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function showSuccess(message) {
    const successBox = document.getElementById('successBox');
    if (successBox) {
        successBox.remove();
    }
    const form = document.querySelector('.post-form');
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert-box success';
    alertDiv.id = 'successBox';
    alertDiv.innerHTML = `
        <span class="alert-icon">âœ“</span>
        <span>${message}</span>
        <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
    `;
    form.insertBefore(alertDiv, form.firstChild.nextSibling);
}

// AI íƒœê·¸ ì¶”ì²œ ê¸°ëŠ¥
document.getElementById('aiTagBtn')?.addEventListener('click', async function() {
    const btn = this;
    const titleInput = document.getElementById('postTitle');
    const editor = document.getElementById('editor');
    const tagsInput = document.getElementById('tagsInput');
    const categorySelect = document.getElementById('categorySelect');
    
    if (!titleInput || !editor) {
        showError('ì œëª©ê³¼ ë³¸ë¬¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const title = titleInput.value.trim();
    const content = editor.innerHTML;
    
    if (!title) {
        showError('ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!content || content.trim().length < 10) {
        showError('ë³¸ë¬¸ ë‚´ìš©ì„ ë” ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 10ì ì´ìƒ)');
        return;
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
    btn.disabled = true;
    btn.textContent = 'â³ AI ë¶„ì„ ì¤‘...';
    
    try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('content', content);
        
        const response = await fetch('/api/posts/ai-tags', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            showError('AI íƒœê·¸ ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
            return;
        }
        
        // ì¹´í…Œê³ ë¦¬ ì ìš©
        if (result.category && categorySelect) {
            categorySelect.value = result.category;
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            const previewCategory = document.getElementById('previewCategory');
            if (previewCategory) {
                previewCategory.textContent = result.category;
            }
        }
        
        // íƒœê·¸ ì ìš©
        if (result.tags && result.tags.length > 0) {
            const recommendedTags = result.tags.join(', ');
            if (tagsInput.value.trim()) {
                tagsInput.value = tagsInput.value + ', ' + recommendedTags;
            } else {
                tagsInput.value = recommendedTags;
            }
            
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            const previewTags = document.getElementById('previewTags');
            if (previewTags) {
                previewTags.innerHTML = result.tags.map(tag => 
                    `<span class="tag">${tag}</span>`
                ).join('');
            }
            
            const confidence = result.category_confidence || 0;
            showSuccess(`AI íƒœê·¸ ì¶”ì²œ ì™„ë£Œ! (ì •í™•ë„: ${Math.round(confidence * 100)}%)`);
        } else {
            showError('ì¶”ì²œí•  íƒœê·¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error('AI íƒœê·¸ ì¶”ì²œ ì˜¤ë¥˜:', error);
        showError('AI íƒœê·¸ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        btn.disabled = false;
        btn.textContent = 'âœ¨ AI íƒœê·¸ ì¶”ì²œ';
    }
});

// í¼ ì œì¶œ ì „ ì—ë””í„° ë‚´ìš©ì„ textareaì— ë³µì‚¬
document.querySelector('form')?.addEventListener('submit', function(e) {
    const editor = document.getElementById('editor');
    const contentHidden = document.getElementById('content');
    const titleInput = document.getElementById('postTitle');
    
    if (!titleInput || !titleInput.value.trim()) {
        e.preventDefault();
        showError('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return false;
    }
    
    if (editor && contentHidden) {
        // ê°¤ëŸ¬ë¦¬ HTML êµ¬ì„±
        const urls = [
            document.getElementById('imageUrl1')?.value.trim(),
            document.getElementById('imageUrl2')?.value.trim(),
            document.getElementById('imageUrl3')?.value.trim()
        ].filter(u => u);

        let galleryHtml = '';
        if (urls.length > 0) {
            galleryHtml += '<div class="carousel"><div class="carousel-inner" id="carouselInner">';
            urls.forEach(u => {
                galleryHtml += `<img src="${u}" alt="ìŠ¤í„°ë”” ì´ë¯¸ì§€"/>`;
            });
            galleryHtml += '</div></div>';
        }

        contentHidden.value = galleryHtml + editor.innerHTML;
        // ë¹ˆ ë‚´ìš© ì²´í¬
        const textContent = editor.innerText.trim();
        if (!textContent || textContent.length === 0) {
            e.preventDefault();
            showError('ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return false;
        }
        
        // HTML íƒœê·¸ë§Œ ìˆê³  ì‹¤ì œ í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” ê²½ìš° ì²´í¬
        const htmlContent = editor.innerHTML.trim();
        if (htmlContent === '<br>' || htmlContent === '<p></p>' || htmlContent === '<div><br></div>') {
            e.preventDefault();
            showError('ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return false;
        }
    }
    
    // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
    const submitBtn = this.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
    }
});
</script>
</body>
</html>
